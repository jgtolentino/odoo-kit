name: supabase-deploy

on:
  push:
    branches: ["main"]
    paths:
      - "supabase/**"
      - ".github/workflows/supabase-deploy.yml"
      - "package.json"
      - "package-lock.json"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

concurrency:
  group: supabase-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Supabase CLI version
        run: npx supabase --version

      - name: Login to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "::error::SUPABASE_ACCESS_TOKEN not set"
            exit 1
          fi

      - name: Link staging project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
        run: |
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "::error::SUPABASE_PROJECT_REF_STAGING not set"
            exit 1
          fi
          npx supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Push DB migrations (staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: npx supabase db push

      - name: Set Edge Function secrets (staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY_B64: ${{ secrets.GITHUB_APP_PRIVATE_KEY_B64 }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Set individual secrets if they exist
          if [ -n "$GITHUB_APP_ID" ]; then
            npx supabase secrets set GITHUB_APP_ID="$GITHUB_APP_ID"
          fi
          if [ -n "$GITHUB_APP_PRIVATE_KEY_B64" ]; then
            npx supabase secrets set GITHUB_APP_PRIVATE_KEY_B64="$GITHUB_APP_PRIVATE_KEY_B64"
          fi
          if [ -n "$ADMIN_API_KEY" ]; then
            npx supabase secrets set ADMIN_API_KEY="$ADMIN_API_KEY"
          fi
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            npx supabase secrets set SLACK_WEBHOOK_URL="$SLACK_WEBHOOK_URL"
          fi

      - name: Deploy Edge Functions (staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: npx supabase functions deploy

      - name: Set database settings (staging)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL_STAGING }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_STAGING }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
        run: |
          if [ -n "$SUPABASE_DB_URL" ] && [ -n "$SUPABASE_URL" ] && [ -n "$ADMIN_API_KEY" ]; then
            psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 <<SQL
              ALTER DATABASE postgres SET app.supabase_url = '${SUPABASE_URL}';
              ALTER DATABASE postgres SET app.repo_auditor_admin_key = '${ADMIN_API_KEY}';
          SQL
            echo "Database settings configured"
          else
            echo "Skipping database settings (missing secrets)"
          fi

  deploy-prod:
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Supabase CLI version
        run: npx supabase --version

      - name: Link prod project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_PROD }}
        run: |
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "::error::SUPABASE_PROJECT_REF_PROD not set"
            exit 1
          fi
          npx supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Push DB migrations (prod)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: npx supabase db push

      - name: Set Edge Function secrets (prod)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          GITHUB_APP_PRIVATE_KEY_B64: ${{ secrets.GITHUB_APP_PRIVATE_KEY_B64 }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$GITHUB_APP_ID" ]; then
            npx supabase secrets set GITHUB_APP_ID="$GITHUB_APP_ID"
          fi
          if [ -n "$GITHUB_APP_PRIVATE_KEY_B64" ]; then
            npx supabase secrets set GITHUB_APP_PRIVATE_KEY_B64="$GITHUB_APP_PRIVATE_KEY_B64"
          fi
          if [ -n "$ADMIN_API_KEY" ]; then
            npx supabase secrets set ADMIN_API_KEY="$ADMIN_API_KEY"
          fi
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            npx supabase secrets set SLACK_WEBHOOK_URL="$SLACK_WEBHOOK_URL"
          fi

      - name: Deploy Edge Functions (prod)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: npx supabase functions deploy

      - name: Set database settings (prod)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_PROD }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
        run: |
          if [ -n "$SUPABASE_DB_URL" ] && [ -n "$SUPABASE_URL" ] && [ -n "$ADMIN_API_KEY" ]; then
            psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 <<SQL
              ALTER DATABASE postgres SET app.supabase_url = '${SUPABASE_URL}';
              ALTER DATABASE postgres SET app.repo_auditor_admin_key = '${ADMIN_API_KEY}';
          SQL
            echo "Database settings configured"
          else
            echo "Skipping database settings (missing secrets)"
          fi

      - name: Verify deployment
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL_PROD }}
        run: |
          if [ -n "$SUPABASE_URL" ]; then
            # Simple health check on the functions endpoint
            curl -sf "${SUPABASE_URL}/functions/v1/health-check" -o /dev/null && echo "Health check passed" || echo "Health check endpoint not available"
          fi
